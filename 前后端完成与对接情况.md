# 前后端完成情况与对接情况

---

## 〇、启动方式

### 方式一：一键脚本（推荐先试）

在项目根目录执行：

```bash
./start.sh
```

若报错或卡住，改用 **方式二**。

### 方式二：分步启动（3 个终端，最稳）

**终端 1 - 后端 (8000)**（把 `~/THETA` 换成你的项目根目录）  
```bash
cd ~/THETA
export PYTHONPATH="$PWD:$PWD/ETM:$PWD/langgraph_agent/backend"
export SIMULATION_MODE=true
cd langgraph_agent/backend
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**终端 2 - DataClean (8001，可选)**  
```bash
cd ~/THETA/ETM/dataclean
# 缺依赖时: pip install -r requirements.txt
PORT=8001 python3 api.py
```

**终端 3 - 前端 (3000)**  
```bash
cd ~/THETA/theta-frontend3
pnpm install
echo "NEXT_PUBLIC_API_URL=http://localhost:8000" > .env.local
echo "NEXT_PUBLIC_DATACLEAN_API_URL=http://localhost:8001" >> .env.local
pnpm run dev
```

然后浏览器打开：**http://localhost:3000**

### 首次登录：创建测试账号

本地数据库 `data/theta.db` 初始为空，需先创建用户。任选一种：

**方式 A：在前端注册**  
打开 http://localhost:3000/register ，注册后用该账号登录。

**方式 B：命令行创建测试账号**（与后端共用 `data/theta.db`）  
在项目根目录执行：
```bash
python3 langgraph_agent/backend/scripts/create_test_user_standalone.py
```
创建后可用：`admin` / `admin123`，`test` / `test123`，`demo` / `demo123` 登录。

### AI 助手（Qwen）配置

AI 助手对话依赖 **DashScope / Qwen API**。未配置 `QWEN_API_KEY` 时，会走规则兜底，无法正常多轮对话。

**密钥已保存在项目根 `.env`**（`QWEN_API_KEY`、`QWEN_MODEL`）。  
`./start.sh` 会从 `项目根/.env` 或 `langgraph_agent/backend/.env` 自动加载；改完后需**重启后端**生效。

- `.env` 已在 `.gitignore`，**请勿提交**；换机或重克隆后，需从 [DashScope 控制台](https://dashscope.console.aliyun.com/) 重新获取 key 并写入 `.env`。
- 若需更改 key 或模型，直接编辑 `.env` 即可。

### 环境与端口

| 服务 | 端口 | 目录 |
|------|------|------|
| 前端 | 3000 | `theta-frontend3/` |
| 后端 API | 8000 | `langgraph_agent/backend/` |
| DataClean | 8001 | `ETM/dataclean/` |

---

## 一、前端完成情况

### 1.1 已实现页面与功能

| 页面/模块 | 路径 | 功能 |
|-----------|------|------|
| 主工作台 | `/` | 聊天、数据清洗、向量化、训练、结果入口；侧边步骤导航 |
| 登录 | `/login` | 用户名+密码，login-json，JWT 存 localStorage |
| 注册 | `/register` | 注册后跳转工作台 |
| 训练 | `/training` | 创建任务、轮询进度、任务列表、取消；与 `/api/tasks` 对接 |
| 结果 | `/results` | 按 dataset/mode 查看结果、指标、主题词 |
| 可视化 | `/visualizations` | 主题词、分布、相似度等图表 |
| 服务监控 | `/admin/monitor` | 健康检查、端口状态（依赖 `/api/health` 等） |

### 1.2 已实现 API 客户端

| 模块 | 文件 | 对接后端 | 主要能力 |
|------|------|----------|----------|
| 主后端 | `lib/api/etm-agent.ts` | `NEXT_PUBLIC_API_URL` | 健康、datasets、upload、tasks、results、preprocessing、chat、suggestions、conversation |
| 认证 | `lib/api/auth.ts` | `NEXT_PUBLIC_API_URL` | register、login-json、me、verify、profile、change-password |
| 数据清洗 | `lib/api/dataclean.ts` | `NEXT_PUBLIC_DATACLEAN_API_URL` | 清洗、格式、任务状态（对接 ETM/dataclean） |

### 1.3 其他前端能力

- **WebSocket**：`use-etm-websocket` 连接 `/api/ws`，subscribe / ping。
- **认证与路由**：`AuthProvider`、`ProtectedRoute`，Token 失效跳转登录。
- **环境变量**：`NEXT_PUBLIC_API_URL`（默认 8000）、`NEXT_PUBLIC_DATACLEAN_API_URL`（默认 8001）。

### 1.4 前端未对接或可选

- **OSS**：`/api/upload/presign`、`/api/oss/datasets` 未在前端封装与使用。
- **Scripts**：`/api/scripts/*`（脚本列表、执行、jobs）未在前端封装。

---

## 二、后端完成情况

### 2.1 已实现路由（按模块）

| 模块 | 前缀 | 端点示例 | 说明 |
|------|------|----------|------|
| 健康 | `/api` | `GET /`, `/health`, `/etm/health` | 存活、GPU、ETM 模块检查 |
| 认证 | `/api/auth` | `POST /register`, `/login`, `/login-json`, `GET /me`, `/verify`, `PUT /profile`, `POST /change-password` | SQLite 用户、JWT |
| 数据 | `/api` | `GET /datasets`, `POST /datasets/upload`, `DELETE /datasets/{name}`, `GET /datasets/{name}` | 本地 DATA_DIR |
| 任务 | `/api` | `POST /tasks`, `GET /tasks`, `GET /tasks/stats`, `GET/DELETE /tasks/{id}`, `GET /tasks/{id}/logs` | TaskStore 持久化，Fire-and-Forget |
| 结果 | `/api` | `GET /results`, `/results/{d}/{m}`, `/metrics`, `/topic-words`, `/visualizations`, `/visualization-data` | RESULT_DIR |
| 聊天 | `/api` | `POST /chat`, `POST /chat/history`, `GET/DELETE /chat/history/{id}`, `POST /chat/suggestions` | Qwen 等 |
| 预处理 | `/api` | `GET /preprocessing/models`, `POST /preprocessing/start`, `GET /preprocessing`, `GET/DELETE /preprocessing/{id}`, `GET /preprocessing/check/{dataset}` | 向量化、BOW、Embedding |
| WebSocket | `/api` | `WS /ws` | 订阅任务、ping/pong |
| OSS（可选） | `/api` | `POST /upload/presign`, `GET /oss/datasets` | 需配置 OSS_* |
| 脚本 | `/api/scripts` | `GET /`, `/categories`, `GET /{id}`, `POST /execute`, `GET/DELETE /jobs`, `POST /train`, `/embedding`, `/evaluate`, `/visualize`, `/pipeline` | 依赖 script_service、服务器脚本目录 |

### 2.2 后端支撑组件

- **用户 / 任务 / 数据集**：`app/models/user.py`、`task.py`、`dataset.py`（SQLAlchemy）。本地开发 `SIMULATION_MODE=true` 时用 **SQLite**（`data/theta.db`）；生产可配 **PostgreSQL**（`DATABASE_URL`）、**Redis**（`REDIS_URL`）可选。
- **任务运行**：`TaskStore`、`etm_agent` 等，部分状态仍写 `result/tasks.json`。
- **ETM**：`etm_agent`、`nodes`、`etm_paths`，依赖 `ETM/` 与 `engine_a`、`engine_c`、`preprocessing`。
- **配置**：`SIMULATION_MODE`、`DATA_DIR`、`RESULT_DIR`、`OSS_*`、`PAI_*`、`CORS_ORIGINS` 等。

---

## 三、前后端对接情况

### 3.1 已对接（前端有调用且后端有实现）

| 能力 | 前端 | 后端 | 状态 |
|------|------|------|------|
| 认证 | auth: register, login-json, me, verify, profile, change-password | /api/auth/* | ✅ 一致 |
| 数据集 | etm-agent: getDatasets, uploadDataset, getDataset, deleteDataset | /api/datasets, /api/datasets/upload, /api/datasets/{name} | ✅ 一致 |
| 任务 | etm-agent: createTask, getTask, getTasks, getTaskStats, getTaskLogs, cancelTask, pollTaskUntilDone | /api/tasks, /api/tasks/{id}, /api/tasks/stats, /api/tasks/{id}/logs | ✅ 一致 |
| 结果 | etm-agent: getResults, getResult, getTopicWords, getMetrics, getVisualizations, getVisualizationData | /api/results/* | ✅ 一致 |
| 预处理 | etm-agent: getEmbeddingModels, startPreprocessing, getPreprocessingJobs, getPreprocessingJob, checkPreprocessingStatus | /api/preprocessing/* | ✅ 一致 |
| 聊天 | etm-agent: chat, getSuggestions, save/get/clear ConversationHistory | /api/chat, /api/chat/suggestions, /api/chat/history | ✅ 一致 |
| 健康 | etm-agent: healthCheck；monitor 页 | /api/health | ✅ 一致 |
| WebSocket | use-etm-websocket | /api/ws | ✅ 一致 |
| 数据清洗 | DataCleanAPI | ETM/dataclean（另起服务，8001） | ✅ 需单独启动 dataclean |

### 3.2 后端有、前端未用（可选）

| 后端 | 说明 |
|------|------|
| /api/upload/presign、/api/oss/datasets | OSS 直传与 OSS 数据集列表，需配置 OSS_* |
| /api/scripts/* | 脚本管理、执行、train/embedding/evaluate/visualize/pipeline |
| /api/etm/health | ETM 模块可用性检查 |
| /api/restart | 服务重启 |
| /api/project | 项目概览 |

### 3.3 环境与路径约定

| 场景 | NEXT_PUBLIC_API_URL | 后端 | NEXT_PUBLIC_DATACLEAN_API_URL |
|------|---------------------|------|-------------------------------|
| 本地一体 | http://localhost:8000 | 本机 8000 | http://localhost:8001 |

- 请求头：`Authorization: Bearer <access_token>`（etm-agent、auth 在 `fetchApi` 中统一加）。
- 路径：前端 `fetchApi('/api/xxx')` 与后端 `/api` 前缀一致；auth 为 `/api/auth/*`。

---

## 四、流程对接摘要

- **登录**：`/login` → `AuthAPI.login` → `POST /api/auth/login-json` → 存 token，请求带 `Authorization`。
- **数据**：上传 → `POST /api/datasets/upload`；列表 → `GET /api/datasets`。
- **向量化**：选数据集 → `POST /api/preprocessing/start`（text_column 可缺省，后端自动检测）→ 轮询 preprocessing 或 check。
- **训练**：选数据集/模式/主题数等 → `POST /api/tasks` → 拿 `task_id` → `GET /api/tasks/{task_id}` 或 `pollTaskUntilDone`；可选 WebSocket 订阅 `/api/ws`。
- **结果与可视化**：`/api/results/{dataset}/{mode}/*`，与 `getResult`、`getTopicWords`、`getMetrics`、`getVisualizations`、`getVisualizationData` 对应。

---

## 五、已修复并对接有影响的问题（此前已处理）

- `run_real_pipeline` 未传 `task_id`，导致返回前端的 `task_id` 与 etm_agent 使用的不一致 → 已改为传入 `task_id` 并正确写 `active_tasks`。
- `task_store.create_task` 参数、`complete_task`/`fail_task` 不存在 → 已改为 `create_task(task_id, …)`、`set_completed`、`set_failed`。
- 前端 training 页错误提示使用旧变量 → 已改为 `NEXT_PUBLIC_API_URL`。

---

## 六、总结表

| 维度 | 状态 |
|------|------|
| 前端页面与主流程 | ✅ 工作台、登录/注册、训练、结果、可视化、监控已实现 |
| 前端 API 封装 | ✅ etm-agent、auth、dataclean 已封装并对接 |
| 后端路由与逻辑 | ✅ 认证、数据、任务、结果、预处理、聊天、WebSocket、健康已实现；OSS、scripts 为可选 |
| 前后端路径与协议 | ✅ 已对接，约定统一；任务 task_id 与轮询/持久化已对齐 |
| 数据清洗 | ✅ 前后端均有，需单独起 ETM/dataclean 服务 |
| OSS、Scripts | 后端已有，前端未接，属可选扩展 |

**结论**：核心链路（登录 → 数据上传 → 向量化 → 训练 → 结果/可视化）前后端均已完成并对接；DataClean 需单独启动（或通过 `start.sh` 尝试一并启动）；OSS 与 Scripts 可按需再接到前端。

**启动**：优先用 `./start.sh`；若不可用，按文档「〇、启动方式 → 方式二」分 3 个终端分别启动后端、DataClean、前端。

**连接失败**：见 `theta-frontend3/连接失败排查.md`。

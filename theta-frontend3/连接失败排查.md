# 连接失败排查

前端报「无法连接到服务器」时，按下面逐项检查。

---

## 1. 后端是否在运行（最常见）

前端请求的是 `http://localhost:8000`，后端必须在本机 8000 端口监听。

**检查：**
```bash
curl -s http://localhost:8000/
# 或
curl -s http://localhost:8000/api/health
```

- 有 JSON 或 HTML → 后端正常，继续看 2、3。
- `Connection refused`、`Failed to connect` → 后端没起来。

**解决：**
- 先试：在项目根目录 `./start.sh`
- 或分步启动后端（在项目根）：
  ```bash
  export PYTHONPATH="$PWD:$PWD/ETM:$PWD/langgraph_agent/backend"
  export SIMULATION_MODE=true
  cd langgraph_agent/backend
  python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
  ```
- 若启动报错：看 `tail -f /tmp/theta_backend.log` 或终端里的 traceback，缺依赖就 `pip install -r langgraph_agent/backend/requirements.txt`。

---

## 2. 前端用的 API 地址对不对

前端通过 `NEXT_PUBLIC_API_URL` 取后端地址，默认 `http://localhost:8000`。  
**改过 .env 后必须重启前端**（`pnpm run dev` / `npm run dev`），否则不会生效。

**检查：**
- 看 `theta-frontend3/.env.local` 是否存在，且含有：
  ```
  NEXT_PUBLIC_API_URL=http://localhost:8000
  ```
- 不能有多余空格、`https`、或其它端口（除非你后端确实开在别处）。
- 浏览器控制台可加一行临时 log 看实际请求的 base：
  - 在 `lib/api/etm-agent.ts` 或 `lib/api/auth.ts` 里 `console.log('API_BASE_URL', API_BASE_URL)`，刷新页面看输出。

**解决：**
```bash
cd theta-frontend3
echo "NEXT_PUBLIC_API_URL=http://localhost:8000" > .env.local
echo "NEXT_PUBLIC_DATACLEAN_API_URL=http://localhost:8001" >> .env.local
# 然后 务必 重启 dev：停掉 pnpm run dev 再重新运行
pnpm run dev
```
若之前配过 SSH/远程地址，`.env.local` 里可能仍是旧值；`./start.sh` 只会在文件不存在时创建，不会覆盖。可删掉 `.env.local` 再跑一次 `./start.sh`，或按上面手动重写。

---

## 3. 端口是否被占或冲突

**检查：**
```bash
lsof -i :8000
lsof -i :3000
```

- 8000 被别的程序占用 → 关掉该程序，或改后端/前端的端口（需同步改 `NEXT_PUBLIC_API_URL` 等）。
- 3000 被占 → 换个前端端口，例如 `pnpm run dev -- -p 3001`，访问 `http://localhost:3001`。

---

## 4. CORS（少见）

后端已允许 `http://localhost:3000`、`http://127.0.0.1:3000`，`DEBUG=true` 时允许所有来源。  
若你用别的地址访问前端（例如 `http://192.168.x.x:3000`），可能会被 CORS 拦。

**解决：** 用 `http://localhost:3000` 或 `http://127.0.0.1:3000` 打开前端；  
或在后端 `app/core/config.py` 的 `CORS_ORIGINS` 里加上你用的前端地址。

---

## 5. 浏览器与网络

- 若用公司/学校网络或 VPN，可能有策略禁止访问 `localhost`，可关 VPN 或换网络试。
- 用无痕/隐私模式，排除插件干扰。

---

## 快速自检清单

| 项 | 命令或操作 |
|----|------------|
| 后端 8000 | `curl -s http://localhost:8000/api/health` 有返回 |
| 前端 .env | `cat theta-frontend3/.env.local` 含 `NEXT_PUBLIC_API_URL=http://localhost:8000` |
| 改 .env 后 | 已重启 `pnpm run dev` |
| 端口 | `lsof -i :8000` 有 python/uvicorn |
| 访问地址 | 使用 `http://localhost:3000` 或 `http://127.0.0.1:3000` |

若都正常仍连不上，把浏览器控制台 (F12 → Console / Network) 里的报错或失败请求的 URL、状态码发出来，便于继续查。
